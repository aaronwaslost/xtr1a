<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://lucide.dev/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xtr1a Activator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              gray: {
                850: '#1f2937',
                900: '#111827',
                950: '#030712',
              },
              cyan: {
                450: '#00d4ff',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #050505;
        color: #e2e8f0;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #111827; 
      }
      ::-webkit-scrollbar-thumb {
        background: #374151; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4b5563; 
      }
      .hidden-tab {
          display: none;
      }
      .active-nav {
          color: #00d4ff; /* cyan-400 */
      }
      .inactive-nav {
          color: #9ca3af; /* gray-400 */
      }
      .inactive-nav:hover {
          color: white;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="selection:bg-cyan-500/30 overflow-x-hidden min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded bg-gradient-to-br from-cyan-600 to-blue-700 flex items-center justify-center shadow-lg shadow-cyan-900/20">
                    <i data-lucide="shield" class="text-white w-5 h-5"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-white">
                    Xtr1a<span class="text-cyan-500">_Activator</span>
                </span>
            </div>
            
            <div class="flex gap-6">
                <button onclick="switchTab('download')" id="nav-download" class="text-sm font-medium transition-colors active-nav">Download Tool</button>
                <button onclick="switchTab('server')" id="nav-server" class="text-sm font-medium transition-colors inactive-nav">Server Setup</button>
                <button onclick="switchTab('register')" id="nav-register" class="text-sm font-medium transition-colors inactive-nav">Register Device</button>
                <a href="https://github.com/rhcp011235/A12_Bypass_OSS" target="_blank" class="flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="github" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="relative flex-grow">
        
        <!-- DOWNLOAD TAB -->
        <div id="tab-download" class="block">
            <section class="pt-24 pb-12 px-6 text-center max-w-4xl mx-auto">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-900/20 border border-cyan-800 text-cyan-400 text-xs font-bold uppercase tracking-wider mb-6">
                    <i data-lucide="zap" class="w-3 h-3"></i>
                    <span>v1.0.3 Release</span>
                </div>
                
                <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 tracking-tight">
                    The Ultimate <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">iOS Utility</span>
                </h1>
                
                <p class="text-lg text-gray-400 mb-10 max-w-2xl mx-auto leading-relaxed">
                    A powerful Python-based GUI tool for iCloud Lock Removal. 
                    Designed for PythonAnywhere backend integration.
                    <br />
                    <span class="text-sm text-gray-500 mt-2 block">Compatible with Windows, macOS, and Linux.</span>
                </p>

                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button onclick="downloadPython()" class="group relative px-8 py-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold transition-all shadow-[0_0_40px_-10px_rgba(6,182,212,0.5)] hover:shadow-[0_0_60px_-10px_rgba(6,182,212,0.6)] flex items-center gap-3">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        <span>Download .py Source</span>
                        <div class="absolute inset-0 rounded-xl ring-2 ring-white/20 group-hover:ring-white/40 transition-all"></div>
                    </button>
                    
                    <button onclick="copyPython()" id="btn-copy-py" class="px-8 py-4 bg-gray-900 hover:bg-gray-800 text-gray-300 border border-gray-700 hover:border-gray-600 rounded-xl font-bold transition-all flex items-center gap-3">
                        <i data-lucide="file-code" class="w-5 h-5" id="icon-copy-py"></i>
                        <span id="text-copy-py">Copy Source</span>
                    </button>
                </div>
            </section>

            <section class="py-20 px-6 max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-6 rounded-2xl bg-gray-900/50 border border-gray-800 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-blue-900/30 rounded-lg flex items-center justify-center mb-4">
                            <i data-lucide="cpu" class="text-blue-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Smart Detection</h3>
                        <p class="text-gray-400 text-sm">
                            Automatically locates required USB communication binaries in system PATH.
                        </p>
                    </div>
                    <div class="p-6 rounded-2xl bg-gray-900/50 border border-gray-800 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-cyan-900/30 rounded-lg flex items-center justify-center mb-4">
                            <i data-lucide="lock" class="text-cyan-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Cloud Auth</h3>
                        <p class="text-gray-400 text-sm">
                            Secure ECID validation using your own private PythonAnywhere server instance.
                        </p>
                    </div>
                    <div class="p-6 rounded-2xl bg-gray-900/50 border border-gray-800 backdrop-blur-sm">
                        <div class="w-12 h-12 bg-purple-900/30 rounded-lg flex items-center justify-center mb-4">
                            <i data-lucide="terminal" class="text-purple-400 w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">Auto-Reboot</h3>
                        <p class="text-gray-400 text-sm">
                            Intelligent loop retries device connection up to 6 times to capture activation logs.
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <!-- SERVER SETUP TAB -->
        <div id="tab-server" class="hidden-tab">
            <section class="pt-24 pb-12 px-6 max-w-4xl mx-auto">
                <div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-8 backdrop-blur-xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">PythonAnywhere Backend</h2>
                            <p class="text-gray-400 text-sm">Deploy this Flask code to your server to handle activations.</p>
                        </div>
                        <button onclick="copyServer()" id="btn-copy-server" class="flex items-center gap-2 px-4 py-2 bg-cyan-900/30 text-cyan-400 rounded-lg hover:bg-cyan-900/50 transition-colors">
                            <i data-lucide="copy" class="w-4 h-4" id="icon-copy-server"></i>
                            <span id="text-copy-server">Copy Code</span>
                        </button>
                    </div>
                    
                    <div class="bg-black/80 rounded-lg p-4 overflow-x-auto border border-gray-800">
                        <pre id="code-block-server" class="text-sm font-mono text-gray-300"></pre>
                    </div>
                </div>
            </section>
        </div>

        <!-- REGISTER DEVICE TAB -->
        <div id="tab-register" class="hidden-tab">
            <section class="pt-24 pb-12 px-6 text-center max-w-2xl mx-auto min-h-[60vh]">
                <div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-8 backdrop-blur-xl">
                    <div class="w-16 h-16 bg-cyan-900/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="smartphone" class="text-cyan-400 w-8 h-8"></i>
                    </div>
                    
                    <h2 class="text-3xl font-bold text-white mb-2">Register Device</h2>
                    <p class="text-gray-400 mb-8">
                        Whitelist your ECID on your activation server.
                    </p>

                    <form id="form-register" class="space-y-4">
                        <div class="flex gap-2">
                            <div class="bg-black/50 border border-gray-700 rounded-lg px-4 py-4 flex items-center justify-center text-gray-500">
                                <i data-lucide="server" class="w-5 h-5"></i>
                            </div>
                            <input 
                                type="text" 
                                id="inp-server"
                                placeholder="Server URL (e.g. myapp.pythonanywhere.com)"
                                class="w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-4 text-white font-mono focus:outline-none focus:border-cyan-500 transition-colors"
                            />
                        </div>

                        <input 
                            type="text" 
                            id="inp-ecid"
                            placeholder="Enter ECID (Hex)"
                            class="w-full bg-black/50 border border-gray-700 rounded-lg px-4 py-4 text-white font-mono text-center focus:outline-none focus:border-cyan-500 transition-colors"
                        />
                        
                        <button 
                            type="submit"
                            id="btn-register"
                            class="w-full font-bold py-4 rounded-lg transition-all shadow-lg shadow-cyan-900/20 bg-cyan-600 hover:bg-cyan-500 text-white flex items-center justify-center gap-2"
                        >
                            <span id="btn-reg-text">Register ECID</span>
                        </button>
                    </form>

                    <!-- Status Container -->
                    <div id="status-container" class="hidden mt-8 p-6 rounded-xl flex flex-col items-center justify-center gap-3 animate-in fade-in zoom-in-95 duration-300">
                        <div id="status-icon-bg" class="p-3 rounded-full">
                           <i id="status-icon" data-lucide="check-circle" class="w-8 h-8"></i>
                        </div>
                        <h3 id="status-title" class="text-xl font-bold"></h3>
                        <p id="status-msg" class="text-center font-mono text-sm opacity-90"></p>
                    </div>

                </div>
            </section>
        </div>

    </main>

    <footer class="py-8 text-center text-gray-600 text-sm border-t border-gray-900/50 mt-12">
        <div class="flex items-center justify-center gap-2 mb-2">
            <i data-lucide="alert-triangle" class="w-3 h-3"></i>
            <span>Only Use on Devices you "OWN"</span>
        </div>
        <p>&copy; 2025 Xtr1a Tools. Not affiliated with Apple Inc.</p>
    </footer>

    <!-- JS LOGIC -->
    <script>
        // --- DATA CONSTANTS ---
        const PYTHON_SOURCE = `import sys
import os
import time
import subprocess
import re
import shutil
import sqlite3
import json
import socket
import threading
import urllib.request
import urllib.error
import zipfile
import io

# GUI Imports
try:
    from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                                 QHBoxLayout, QLabel, QPushButton, QLineEdit, 
                                 QTextEdit, QTabWidget, QGroupBox, QComboBox, 
                                 QMessageBox, QProgressBar, QFrame, QScrollArea,
                                 QRadioButton, QFileDialog, QSplitter, QGridLayout)
    from PyQt6.QtCore import Qt, QThread, pyqtSignal, QObject, QTimer, QSize, QByteArray
    from PyQt6.QtGui import QFont, QIcon, QColor, QPalette, QCursor, QGradient, QBrush, QLinearGradient, QClipboard
except ImportError:
    print("CRITICAL ERROR: PyQt6 is not installed.")
    print("Please run: pip install PyQt6 pymobiledevice3 requests")
    sys.exit(1)

# --- Configuration ---
APP_NAME = "Xtr1a Activator"
VERSION = "v1.0.3"

# --- Modern Cyber-Clean Stylesheet ---
STYLESHEET = """
QMainWindow {
    background-color: #09090b; /* Zinc 950 */
}
QWidget {
    font-family: 'Segoe UI', 'Inter', sans-serif;
    font-size: 13px;
    color: #e4e4e7; /* Zinc 200 */
}
QFrame#SidePanel {
    background-color: #000000;
    border-right: 1px solid #27272a; /* Zinc 800 */
}
QFrame#Header {
    background-color: #09090b;
    border-bottom: 1px solid #27272a;
}
QLabel#HeaderTitle {
    font-size: 24px;
    font-weight: 800;
    color: #ffffff;
    letter-spacing: -0.5px;
}
QLabel#VersionTag {
    color: #06b6d4; /* Cyan 500 */
    background-color: rgba(6, 182, 212, 0.1);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 600;
}
QLabel#SectionTitle {
    font-size: 11px;
    font-weight: 700;
    color: #71717a; /* Zinc 500 */
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 8px;
}
QLabel#DetailLabel {
    color: #71717a; 
    font-size: 10px; 
    font-weight: 700;
    text-transform: uppercase;
}
QLabel#DetailValue {
    color: #e4e4e7; 
    font-family: 'Consolas', monospace; 
    font-size: 13px;
    padding-bottom: 2px;
    border-bottom: 1px solid #27272a;
}
QLineEdit {
    background-color: #18181b; /* Zinc 900 */
    border: 1px solid #27272a;
    border-radius: 6px;
    padding: 12px;
    color: #ffffff;
    font-family: 'Consolas', monospace;
    font-size: 13px;
}
QLineEdit:focus {
    border: 1px solid #06b6d4;
    background-color: #27272a;
}
QLineEdit:disabled {
    color: #52525b;
    background-color: #09090b;
    border-color: #18181b;
}
QPushButton {
    background-color: #18181b;
    border: 1px solid #27272a;
    border-radius: 6px;
    padding: 10px 16px;
    color: #e4e4e7;
    font-weight: 600;
    font-size: 12px;
}
QPushButton:hover {
    background-color: #27272a;
    border-color: #3f3f46;
}
QPushButton:pressed {
    background-color: #000000;
}
QPushButton#PrimaryButton {
    background-color: #0891b2; /* Cyan 600 */
    border: 1px solid #0e7490;
    color: #ffffff;
    font-size: 14px;
    padding: 14px;
}
QPushButton#PrimaryButton:hover {
    background-color: #06b6d4; /* Cyan 500 */
}
QPushButton#PrimaryButton:disabled {
    background-color: #1e293b;
    border-color: #334155;
    color: #64748b;
}
QPushButton#SmallBtn {
    padding: 4px 8px;
    font-size: 10px;
    border-radius: 4px;
    background-color: #27272a;
}
QPushButton#SmallBtn:hover {
    background-color: #3f3f46;
}
QPushButton#DestructiveButton {
    background-color: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #f87171;
}
QPushButton#DestructiveButton:hover {
    background-color: #dc2626;
    color: white;
}
QTextEdit {
    background-color: #000000;
    border: 1px solid #27272a;
    border-radius: 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    padding: 12px;
    line-height: 1.4;
    color: #d4d4d8;
}
QGroupBox {
    border: 1px solid #27272a;
    border-radius: 8px;
    margin-top: 12px;
    padding-top: 24px;
    padding-bottom: 12px;
    background-color: #0c0c0e;
}
QGroupBox::title {
    subcontrol-origin: margin;
    left: 12px;
    top: 8px;
    padding: 0 4px;
    color: #22d3ee; /* Cyan 400 */
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
QTabWidget::pane { border: 0; background: transparent; }
QTabBar::tab {
    background-color: transparent;
    color: #71717a;
    padding: 12px 0;
    margin-right: 24px;
    font-weight: 600;
    border-bottom: 2px solid transparent;
}
QTabBar::tab:selected {
    color: #06b6d4;
    border-bottom: 2px solid #06b6d4;
}
"""

# --- Worker Classes ---

class ConsoleSignal(QObject):
    text_written = pyqtSignal(str, str)

class DeviceWorker(QThread):
    info_ready = pyqtSignal(dict)
    error_occurred = pyqtSignal(str)

    def run(self):
        # Prefer direct module call for speed
        pmd3 = shutil.which("pymobiledevice3")
        commands = []
        if pmd3:
            commands.append([pmd3, "lockdown", "info"])
        commands.append([sys.executable, "-m", "pymobiledevice3", "lockdown", "info"])
        
        success = False
        last_error = ""

        for cmd in commands:
            try:
                flags = subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0
                res = subprocess.run(cmd, capture_output=True, text=True, creationflags=flags)
                
                if res.returncode == 0 and res.stdout:
                    try:
                        data = json.loads(res.stdout)
                        self.process_data(data)
                        success = True
                        break
                    except json.JSONDecodeError:
                        self.parse_text(res.stdout)
                        success = True
                        break
                else:
                    last_error = res.stderr.strip()
            except Exception as e:
                last_error = str(e)
        
        if not success:
            self.error_occurred.emit(f"Failed to detect device. Ensure device is connected and unlocked.")

    def process_data(self, info):
        # Handle ECID from integer or hex string
        ecid_raw = info.get("UniqueChipID", info.get("ECID", 0))
        ecid_hex = hex(ecid_raw).upper().replace("0X", "") if isinstance(ecid_raw, int) else str(ecid_raw)

        clean = {
            "ModelName": info.get("DeviceName", "Unknown Device"),
            "ModelID": info.get("ProductType", "Unknown"),
            "Serial": info.get("SerialNumber", "N/A"),
            "UDID": info.get("UniqueDeviceID", ""),
            "iOS": info.get("ProductVersion", "Unknown"),
            "IMEI": info.get("InternationalMobileEquipmentIdentity", "N/A"),
            "ECID": ecid_hex,
            "Activation": info.get("ActivationState", "Unknown"),
            "Capacity": info.get("DeviceCapacity", "N/A")
        }
        
        # Determine capacity readability if available
        if isinstance(clean["Capacity"], int):
            clean["Capacity"] = f"{clean['Capacity'] // 1073741824} GB"

        if not clean["UDID"]:
            self.error_occurred.emit("Device detected but UDID is missing. Trust Computer?")
        else:
            self.info_ready.emit(clean)

    def parse_text(self, output):
        info = {}
        for line in output.splitlines():
            if ": " in line:
                k, v = line.split(": ", 1)
                info[k.strip()] = v.strip()
                
        # Handle int conversion for ECID if text parsing
        if "UniqueChipID" in info:
            try:
                info["UniqueChipID"] = int(info["UniqueChipID"])
            except:
                pass
        self.process_data(info)

class BypassWorker(QThread):
    finished = pyqtSignal(bool, str)
    
    def __init__(self, console_signal, device_info, base_url, use_auto_guid, manual_guid):
        super().__init__()
        self.console = console_signal
        self.dev = device_info
        
        # Format URL: Ensure protocol
        self.base_url = base_url.strip()
        if not self.base_url.startswith("http"):
            self.base_url = "https://" + self.base_url
        self.base_url = self.base_url.rstrip("/")
        
        self.auto_guid = use_auto_guid
        self.man_guid = manual_guid

    def log(self, msg, color="#a1a1aa"):
        self.console.text_written.emit(msg, color)

    def run_cmd(self, cmd, timeout=None):
        try:
            flags = subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0
            res = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout, creationflags=flags)
            return res.returncode, res.stdout.strip(), res.stderr.strip()
        except subprocess.TimeoutExpired:
            return 124, "", "Timed out"
        except Exception as e:
            return 1, "", str(e)

    def check_registration(self):
        ecid = self.dev.get("ECID")
        self.log(f"Verifying ECID {ecid} with {self.base_url}...", "#d4d4d8")
        
        url = f"{self.base_url}/check_ecid?ecid={ecid}"
        
        try:
            req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
            with urllib.request.urlopen(req, timeout=8) as r:
                data = r.read().decode('utf-8').strip()
                if "REGISTERED" in data.upper() and "UNREGISTERED" not in data.upper():
                    self.log("Registration Verified: AUTHORIZED", "#4ade80")
                    return True
                else:
                    self.log(f"Server Validation Failed. Response: {data}", "#ef4444")
                    self.log("Please register ECID on the website first.", "#fbbf24")
                    return False
        except urllib.error.HTTPError as e:
             self.log(f"HTTP Error {e.code}: Check your server URL.", "#ef4444")
             return False
        except Exception as e:
            self.log(f"Connection failed: {e}", "#ef4444")
            self.log("Could not reach server. Is the URL correct?", "#fbbf24")
            return False

    def run(self):
        self.log(f"--- Starting Bypass Process {VERSION} ---", "#22d3ee")
        
        if not self.check_registration():
            self.finished.emit(False, "ECID Registration Required")
            return

        # Auto-Reboot Loop (Max 6 attempts)
        max_retries = 6
        guid = None

        if self.auto_guid:
            for attempt in range(1, max_retries + 1):
                self.log(f"Attempt {attempt}/{max_retries}: Scanning for Activation GUID...", "#fbbf24")
                
                guid = self.detect_guid_once()
                
                if guid:
                    break # Found it!
                
                if attempt < max_retries:
                    self.log(f"GUID not found. Rebooting device to trigger logs...", "#ef4444")
                    self.perform_reboot()
                    self.wait_for_device() 
                else:
                    self.log("Max retries reached. Could not find GUID.", "#ef4444")
                    self.finished.emit(False, "Failed to find GUID after 6 reboots")
                    return
        else:
            guid = self.man_guid
            self.log(f"Using Manual GUID: {guid}", "#38bdf8")

        if not guid:
            self.finished.emit(False, "No GUID available")
            return
            
        self.log(f"GUID Acquired: {guid}", "#4ade80")
        
        # 2. Server Comms
        self.log("Requesting payload URLs...", "#d4d4d8")
        s1, s2, s3 = self.get_urls(guid)
        
        if not s3:
            self.log("Failed to get payload URLs. Check Server.", "#ef4444")
            self.finished.emit(False, "Server Error")
            return
            
        # 3. Download & Push
        self.log("Downloading Stage 3 Payload...", "#d4d4d8")
        if self.download_and_push(s3):
            self.log("‚úÖ Payload Successfully Deployed!", "#4ade80")
            self.log("FINAL STEPS:", "#fbbf24")
            self.log("1. Device will reboot automatically (or do it manually)", "#e4e4e7")
            self.log("2. Copy /iTunes_Control/iTunes/iTunesMetadata.plist to /Books/", "#e4e4e7")
            self.finished.emit(True, "Deployment Complete")
        else:
            self.finished.emit(False, "Deployment Failed")

    def perform_reboot(self):
        try:
            flags = subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0
            subprocess.Popen([sys.executable, "-m", "pymobiledevice3", "diagnostics", "restart"], creationflags=flags)
            self.log("Reboot signal sent.", "#d4d4d8")
        except:
            self.log("Reboot command failed. Please reboot manually.", "#ef4444")

    def wait_for_device(self):
        self.log("Waiting for device to reconnect (max 60s)...", "#d4d4d8")
        # Optimized Wait: 60 seconds max, checking every second
        for i in range(60):
            time.sleep(1)
            
            # Use quick check command
            cmd = [sys.executable, "-m", "pymobiledevice3", "lockdown", "info"]
            try:
                flags = subprocess.CREATE_NO_WINDOW if sys.platform == 'win32' else 0
                r = subprocess.run(cmd, capture_output=True, creationflags=flags)
                if r.returncode == 0:
                    self.log("Device Reconnected! Resuming scan...", "#4ade80")
                    time.sleep(4) # Allow USB services to fully initialize
                    return
            except:
                pass
                
        self.log("Timeout waiting for device. Proceeding anyway...", "#facc15")

    def detect_guid_once(self):
        udid = self.dev.get("UDID")
        log_file = f"search_{udid}.logarchive"
        
        if os.path.exists(log_file): shutil.rmtree(log_file)
        
        cmd = [sys.executable, "-m", "pymobiledevice3", "syslog", "collect", log_file]
        
        self.log("Collecting logs (45s)...", "#d4d4d8")
        self.run_cmd(cmd, timeout=45) 
        
        trace = os.path.join(log_file, "logdata.LiveData.tracev3")
        if not os.path.exists(trace):
            return None
            
        try:
            with open(trace, 'rb') as f:
                content = f.read()
            
            pattern = re.compile(rb'[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}', re.IGNORECASE)
            matches = pattern.findall(content)
            
            from collections import Counter
            valid = [m.decode('ascii').upper() for m in matches if len(m.replace(b'0', b'').replace(b'-', b'')) > 5]
            
            if not valid: return None
            return Counter(valid).most_common(1)[0][0]
            
        except:
            return None
        finally:
            if os.path.exists(log_file): shutil.rmtree(log_file)

    def get_urls(self, guid):
        sn = self.dev.get("Serial")
        prd = self.dev.get("ModelID")
        url = f"{self.base_url}/get_payload?prd={prd}&guid={guid}&sn={sn}"
        
        # Use curl or python urllib
        try:
            req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
            with urllib.request.urlopen(req, timeout=10) as r:
                out = r.read().decode('utf-8')
                js = json.loads(out)
                if js.get('success'):
                    l = js['links']
                    return l.get('step1_fixedfile'), l.get('step2_bldatabase'), l.get('step3_final')
        except Exception as e:
            self.log(f"URL Fetch Error: {e}", "#ef4444")
            
        return None, None, None

    def download_and_push(self, url):
        local = "payload.db"
        if os.path.exists(local): os.remove(local)
        
        self.run_cmd(["curl", "-L", "-o", local, url])
        
        try:
            conn = sqlite3.connect(local)
            cursor = conn.cursor()
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='asset'")
            if not cursor.fetchone():
                conn.close()
                return False
            conn.close()
        except:
            return False
            
        target = "/Downloads/downloads.28.sqlitedb"
        self.log("Pushing payload...", "#d4d4d8")
        self.run_cmd([sys.executable, "-m", "pymobiledevice3", "afc", "rm", target])
        c, _, _ = self.run_cmd([sys.executable, "-m", "pymobiledevice3", "afc", "push", local, target])
        return c == 0

# --- Main Window ---

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"{APP_NAME} {VERSION}")
        self.resize(1100, 800)
        self.device_info = {}
        self.console_signal = ConsoleSignal()
        self.console_signal.text_written.connect(self.log_msg)

        self.init_ui()

    def init_ui(self):
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        main_layout = QHBoxLayout(main_widget)
        main_layout.setContentsMargins(0,0,0,0)
        main_layout.setSpacing(0)

        # Side Panel
        side_panel = QFrame()
        side_panel.setObjectName("SidePanel")
        side_panel.setFixedWidth(260)
        sp_layout = QVBoxLayout(side_panel)
        sp_layout.setContentsMargins(24, 40, 24, 24)
        
        logo_lbl = QLabel(APP_NAME.split(' ')[0])
        logo_lbl.setObjectName("HeaderTitle")
        sp_layout.addWidget(logo_lbl)
        
        ver_lbl = QLabel(VERSION)
        ver_lbl.setObjectName("VersionTag")
        ver_lbl.setFixedSize(100, 22)
        ver_lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
        sp_layout.addWidget(ver_lbl)
        
        sp_layout.addSpacing(50)
        
        self.nav_btns = []
        icons = ["üñ•Ô∏è", "‚òÅÔ∏è", "üìñ"]
        labels = ["Dashboard", "Server Config", "Guide & Info"]
        
        for i, text in enumerate(labels):
            btn = QPushButton(f"{icons[i]}   {text}")
            btn.setCheckable(True)
            btn.setFixedHeight(48)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            btn.setStyleSheet("""
                QPushButton { text-align: left; padding-left: 20px; border: 0; background: transparent; color: #a1a1aa; font-size: 14px; font-weight: 500; border-radius: 8px; }
                QPushButton:checked { color: #ffffff; font-weight: 600; background: #18181b; border: 1px solid #27272a; }
                QPushButton:hover { color: #ffffff; background: #09090b; }
            """)
            btn.clicked.connect(lambda c, idx=i: self.change_tab(idx))
            sp_layout.addWidget(btn)
            sp_layout.addSpacing(4)
            self.nav_btns.append(btn)
            
        sp_layout.addStretch()
        main_layout.addWidget(side_panel)

        # Content
        content_area = QWidget()
        ca_layout = QVBoxLayout(content_area)
        ca_layout.setContentsMargins(0,0,0,0)
        
        header = QFrame()
        header.setObjectName("Header")
        header.setFixedHeight(70)
        h_layout = QHBoxLayout(header)
        h_layout.setContentsMargins(40, 0, 40, 0)
        self.header_title = QLabel("DASHBOARD")
        self.header_title.setStyleSheet("font-size: 18px; font-weight: 700; color: #ffffff; letter-spacing: 0.5px;")
        h_layout.addWidget(self.header_title)
        ca_layout.addWidget(header)
        
        self.tabs = QTabWidget()
        self.tabs.tabBar().hide()
        
        self.page_dash = QWidget()
        self.page_server = QWidget()
        self.page_guide = QWidget()
        
        self.tabs.addTab(self.page_dash, "")
        self.tabs.addTab(self.page_server, "")
        self.tabs.addTab(self.page_guide, "")
        
        ca_layout.addWidget(self.tabs)
        main_layout.addWidget(content_area)

        self.build_dashboard()
        self.build_server_page()
        self.build_guide_page()
        self.nav_btns[0].click()

    def change_tab(self, index):
        for i, btn in enumerate(self.nav_btns):
            btn.setChecked(i == index)
        self.tabs.setCurrentIndex(index)
        self.header_title.setText(self.nav_btns[index].text().split("   ")[1].upper())

    def build_dashboard(self):
        layout = QHBoxLayout(self.page_dash)
        layout.setContentsMargins(40, 40, 40, 40)
        layout.setSpacing(40)
        
        # Left Panel
        left_panel = QWidget()
        lp_layout = QVBoxLayout(left_panel)
        lp_layout.setContentsMargins(0,0,0,0)
        lp_layout.setSpacing(20)
        left_panel.setFixedWidth(450) # Wider for details

        # 1. Connection Header
        conn_box = QFrame()
        conn_box.setStyleSheet("background-color: #0c0c0e; border: 1px solid #27272a; border-radius: 8px;")
        conn_layout = QHBoxLayout(conn_box)
        conn_layout.setContentsMargins(16, 16, 16, 16)
        
        self.status_lbl = QLabel("DISCONNECTED")
        self.status_lbl.setStyleSheet("color: #71717a; font-weight: 800; font-size: 16px;")
        
        btn_check = QPushButton("CHECK DEVICE")
        btn_check.setObjectName("PrimaryButton")
        btn_check.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        btn_check.clicked.connect(self.check_device)
        
        conn_layout.addWidget(self.status_lbl)
        conn_layout.addStretch()
        conn_layout.addWidget(btn_check)

        # 2. Detailed Info Grid
        dev_box = QGroupBox("DEVICE IDENTITY")
        # Use GridLayout for spacious display
        grid = QGridLayout()
        grid.setContentsMargins(16, 24, 16, 16)
        grid.setVerticalSpacing(20)
        grid.setHorizontalSpacing(24)

        # Helper to make label/value pairs
        def mk_field(row, col, title, obj_name, colspan=1):
            lbl = QLabel(title)
            lbl.setObjectName("DetailLabel")
            val = QLabel("-")
            val.setObjectName("DetailValue")
            grid.addWidget(lbl, row*2, col, 1, colspan)
            grid.addWidget(val, row*2+1, col, 1, colspan)
            setattr(self, obj_name, val)

        # Row 0: Model | iOS
        mk_field(0, 0, "MODEL NAME", "val_model")
        mk_field(0, 1, "IOS VERSION", "val_ios")
        
        # Row 1: Model ID | Serial
        mk_field(1, 0, "MODEL IDENTIFIER", "val_modelid")
        mk_field(1, 1, "SERIAL NUMBER", "val_serial")

        # Row 2: IMEI | Activation
        mk_field(2, 0, "IMEI", "val_imei")
        mk_field(2, 1, "ACTIVATION STATE", "val_act")

        # Row 3: Storage (Reduced items)
        mk_field(3, 0, "STORAGE CAPACITY", "val_storage", 2)
        
        # Row 4: ECID (Full with Copy)
        lbl_ecid = QLabel("ECID (UNIQUE CHIP ID)")
        lbl_ecid.setObjectName("DetailLabel")
        grid.addWidget(lbl_ecid, 8, 0, 1, 2)
        
        ecid_layout = QHBoxLayout()
        self.val_ecid = QLineEdit()
        self.val_ecid.setReadOnly(True)
        self.val_ecid.setText("-")
        self.val_ecid.setStyleSheet("background: transparent; border: none; border-bottom: 1px solid #27272a; color: #e4e4e7; font-family: 'Consolas'; padding: 0; padding-bottom: 4px;")
        
        btn_copy = QPushButton("COPY")
        btn_copy.setObjectName("SmallBtn")
        btn_copy.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        btn_copy.setFixedWidth(60)
        btn_copy.clicked.connect(self.copy_ecid)
        
        ecid_layout.addWidget(self.val_ecid)
        ecid_layout.addWidget(btn_copy)
        
        # Add layout to grid at Row 4 index (8/9)
        grid.addLayout(ecid_layout, 9, 0, 1, 2)

        dev_box.setLayout(grid)

        # 3. Action
        self.btn_bypass = QPushButton("INITIATE BYPASS SEQUENCE")
        self.btn_bypass.setObjectName("PrimaryButton")
        self.btn_bypass.setFixedHeight(56)
        self.btn_bypass.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.btn_bypass.clicked.connect(self.start_bypass)

        lp_layout.addWidget(conn_box)
        lp_layout.addWidget(dev_box)
        lp_layout.addStretch()
        lp_layout.addWidget(self.btn_bypass)

        # Right Panel
        right_panel = QWidget()
        rp_layout = QVBoxLayout(right_panel)
        rp_layout.setContentsMargins(0,0,0,0)
        
        lbl_con = QLabel("SYSTEM TERMINAL")
        lbl_con.setObjectName("SectionTitle")
        
        self.console = QTextEdit()
        self.console.setReadOnly(True)
        
        rp_layout.addWidget(lbl_con)
        rp_layout.addWidget(self.console)
        
        layout.addWidget(left_panel)
        layout.addWidget(right_panel)

    def build_server_page(self):
        layout = QVBoxLayout(self.page_server)
        layout.setContentsMargins(60, 60, 60, 60)
        layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        
        box = QGroupBox("REMOTE SERVER CONFIGURATION")
        bl = QVBoxLayout()
        bl.setContentsMargins(30, 30, 30, 30)
        bl.setSpacing(20)
        
        lbl_desc = QLabel("Enter your PythonAnywhere or Custom Server URL below. The tool will check ECID registration against this server.")
        lbl_desc.setStyleSheet("color: #a1a1aa; margin-bottom: 10px;")
        lbl_desc.setWordWrap(True)
        
        lbl_ip = QLabel("SERVER DOMAIN / URL")
        lbl_ip.setObjectName("SectionTitle")
        self.inp_domain = QLineEdit()
        self.inp_domain.setPlaceholderText("https://yourusername.pythonanywhere.com")
        self.inp_domain.setText("https://xtr1a.pythonanywhere.com") # Default placeholder
        
        bl.addWidget(lbl_desc)
        bl.addWidget(lbl_ip)
        bl.addWidget(self.inp_domain)
        bl.addStretch()
        
        box.setLayout(bl)
        layout.addWidget(box)

    def build_guide_page(self):
        layout = QVBoxLayout(self.page_guide)
        layout.setContentsMargins(40, 40, 40, 40)
        txt = QTextEdit()
        txt.setReadOnly(True)
        txt.setHtml("""
        <h3>INSTRUCTIONS</h3>
        <p>1. Connect Device & Click Check.</p>
        <p>2. Copy the ECID and Register it on the website (using the Server Code).</p>
        <p>3. Enter your Server URL in the 'Server Config' tab.</p>
        <p>4. Ensure Device is on same WiFi as this PC.</p>
        <p>5. Click Initiate Bypass. The tool will auto-reboot the device up to 6 times to catch the activation logs.</p>
        """)
        layout.addWidget(txt)

    # --- Logic ---

    def log_msg(self, msg, color):
        self.console.append(f"<span style='color:{color}'>{msg}</span>")
        sb = self.console.verticalScrollBar()
        sb.setValue(sb.maximum())

    def check_device(self):
        self.status_lbl.setText("CONNECTING...")
        self.status_lbl.setStyleSheet("color: #fbbf24; font-weight: 800; font-size: 16px;")
        
        self.worker = DeviceWorker()
        self.worker.info_ready.connect(self.on_dev_found)
        self.worker.error_occurred.connect(self.on_dev_err)
        self.worker.start()

    def on_dev_found(self, info):
        self.device_info = info
        self.val_model.setText(info['ModelName'])
        self.val_modelid.setText(info['ModelID'])
        self.val_ios.setText(info['iOS'])
        self.val_serial.setText(info['Serial'])
        self.val_imei.setText(info['IMEI'])
        self.val_act.setText(info['Activation'])
        self.val_ecid.setText(str(info['ECID']))
        self.val_storage.setText(info['Capacity'])

        color = "#4ade80" if "Activated" in info['Activation'] else "#f87171"
        self.val_act.setStyleSheet(f"color: {color}; font-family: 'Consolas'; font-weight: bold; border-bottom: 1px solid #27272a;")

        self.status_lbl.setText("CONNECTED")
        self.status_lbl.setStyleSheet("color: #4ade80; font-weight: 800; font-size: 16px;")
        self.log_msg(f"Connected: {info['ModelName']}", "#4ade80")

    def on_dev_err(self, err):
        self.status_lbl.setText("ERROR")
        self.status_lbl.setStyleSheet("color: #ef4444; font-weight: 800; font-size: 16px;")
        self.log_msg(err, "#ef4444")

    def copy_ecid(self):
        txt = self.val_ecid.text()
        if txt and txt != "-":
            cb = QApplication.clipboard()
            cb.setText(txt)
            self.log_msg("ECID copied to clipboard.", "#22d3ee")

    def start_bypass(self):
        if not self.device_info.get("UDID"):
            QMessageBox.warning(self, "Error", "Check device first.")
            return

        # Prompt Wifi
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Icon.Warning)
        msg.setText("Important Pre-Check")
        msg.setInformativeText("Ensure the iDevice is connected to the SAME Wi-Fi network as this computer before proceeding.\\n\\nThe device must be registered via ECID.")
        msg.setStandardButtons(QMessageBox.StandardButton.Ok | QMessageBox.StandardButton.Cancel)
        if msg.exec() != QMessageBox.StandardButton.Ok:
            return

        url = self.inp_domain.text().strip()
        if not url:
            QMessageBox.critical(self, "Error", "Please configure Server URL in the 'Server Config' tab.")
            return

        self.btn_bypass.setEnabled(False)
        self.console.clear()
        
        self.bp_worker = BypassWorker(
            self.console_signal,
            self.device_info,
            url,
            True, # Always auto guid now
            ""
        )
        self.bp_worker.finished.connect(self.on_bp_finish)
        self.bp_worker.start()

    def on_bp_finish(self, success, msg):
        self.btn_bypass.setEnabled(True)
        if success: QMessageBox.information(self, "Success", msg)
        else: self.log_msg(f"FAILED: {msg}", "#ef4444")

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyleSheet(STYLESHEET)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
`;

        const FLASK_SERVER_CODE = `from flask import Flask, request, jsonify
import sqlite3
import os

# ==========================================
# PYTHONANYWHERE FLASK CONFIGURATION
# ==========================================
# 1. Upload this file as 'flask_app.py' to your PythonAnywhere directory.
# 2. Go to the "Web" tab and configure your WSGI file to import 'app' from this file.
# 3. Create a 'static' folder for your payload files if needed.

app = Flask(__name__)
DB_FILE = "devices.db"

def init_db():
    with sqlite3.connect(DB_FILE) as conn:
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS devices 
                     (ecid TEXT PRIMARY KEY, 
                      ip_address TEXT, 
                      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)''')
        conn.commit()

# Ensure DB exists on startup
if not os.path.exists(DB_FILE):
    init_db()

@app.route('/')
def index():
    return jsonify({"status": "Xtr1a Activator Server Online", "version": "1.0.3"})

@app.route('/register_ecid', methods=['GET', 'POST'])
def register():
    """Endpoint for the Web App to register a device."""
    ecid = request.args.get('ecid')
    if not ecid:
        return jsonify({"success": False, "message": "Missing ECID parameter"}), 400
    
    ecid = ecid.upper().strip()
    client_ip = request.remote_addr
    
    try:
        with sqlite3.connect(DB_FILE) as conn:
            # Insert or replace to allow re-registration
            conn.execute("INSERT OR REPLACE INTO devices (ecid, ip_address) VALUES (?, ?)", (ecid, client_ip))
        return jsonify({"success": True, "message": f"ECID {ecid} Registered Successfully"})
    except Exception as e:
        return jsonify({"success": False, "message": str(e)}), 500

@app.route('/check_ecid', methods=['GET'])
def check():
    """Endpoint for the Python Tool to verify permission."""
    ecid = request.args.get('ecid')
    if not ecid:
        return "MISSING_PARAM", 400
    
    ecid = ecid.upper().strip()
    
    with sqlite3.connect(DB_FILE) as conn:
        cur = conn.cursor()
        cur.execute("SELECT 1 FROM devices WHERE ecid = ?", (ecid,))
        row = cur.fetchone()
        
    if row:
        return "REGISTERED"
    else:
        return "UNREGISTERED"

@app.route('/get_payload', methods=['GET'])
def get_payload():
    """Endpoint to return payload URLs."""
    guid = request.args.get('guid')
    model = request.args.get('prd')
    
    # NOTE: You must host your 'payload.db' file.
    # On PythonAnywhere, put it in a 'static' folder and use the URL below.
    # payload_url = f"{request.url_root}static/payload.db"
    
    # For now, we return a placeholder or a direct link if you have one
    payload_url = "https://github.com/rhcp011235/A12_Bypass_OSS/raw/main/payload.db" 

    return jsonify({
        "success": True,
        "links": {
            "step1_fixedfile": payload_url,
            "step2_bldatabase": payload_url,
            "step3_final": payload_url
        }
    })

if __name__ == '__main__':
    app.run(port=8000)`;

        // --- INIT ---
        lucide.createIcons();
        document.getElementById('code-block-server').innerText = FLASK_SERVER_CODE;

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            ['download', 'server', 'register'].forEach(t => {
                document.getElementById('tab-' + t).style.display = (t === tabName) ? 'block' : 'none';
                const nav = document.getElementById('nav-' + t);
                if (t === tabName) {
                    nav.classList.add('active-nav');
                    nav.classList.remove('inactive-nav');
                } else {
                    nav.classList.add('inactive-nav');
                    nav.classList.remove('active-nav');
                }
            });
        }

        // --- DOWNLOAD PYTHON ---
        function downloadPython() {
            const blob = new Blob([PYTHON_SOURCE], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Xtr1a_Activator.py';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- COPY PYTHON ---
        function copyPython() {
            navigator.clipboard.writeText(PYTHON_SOURCE);
            const icon = document.getElementById('icon-copy-py');
            const text = document.getElementById('text-copy-py');
            // Change UI temporarily
            const originalIcon = icon.getAttribute('data-lucide');
            icon.setAttribute('class', 'text-green-500 w-5 h-5'); // rudimentary visual change not changing icon svg in vanilla easily without re-render
            text.innerText = "Copied!";
            text.classList.add('text-green-500');
            setTimeout(() => {
                text.innerText = "Copy Source";
                text.classList.remove('text-green-500');
                icon.setAttribute('class', 'w-5 h-5');
            }, 2000);
        }

        // --- COPY SERVER ---
        function copyServer() {
            navigator.clipboard.writeText(FLASK_SERVER_CODE);
            const text = document.getElementById('text-copy-server');
            text.innerText = "Copied!";
            text.classList.add('text-green-400');
            setTimeout(() => {
                text.innerText = "Copy Code";
                text.classList.remove('text-green-400');
            }, 2000);
        }

        // --- REGISTER ---
        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-register');
            const btnText = document.getElementById('btn-reg-text');
            const statusDiv = document.getElementById('status-container');
            const statusTitle = document.getElementById('status-title');
            const statusMsg = document.getElementById('status-msg');
            const iconBg = document.getElementById('status-icon-bg');
            const icon = document.getElementById('status-icon');

            const ecid = document.getElementById('inp-ecid').value.trim();
            let url = document.getElementById('inp-server').value.trim();

            if (ecid.length < 5) {
                alert("Invalid ECID Length");
                return;
            }
            if (!url) {
                alert("Please enter Server URL");
                return;
            }

            url = url.replace(/\/$/, "");
            if (!url.startsWith('http')) url = 'https://' + url;

            // Set Loading
            btn.disabled = true;
            btnText.innerText = "Connecting...";
            btn.classList.add('opacity-75');
            statusDiv.classList.add('hidden');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${url}/register_ecid?ecid=${ecid}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                let data = {};
                const contentType = response.headers.get("content-type");
                
                if (contentType && contentType.includes("application/json")) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = { message: "Invalid JSON response" };
                    }
                } else {
                    const text = await response.text();
                    data = { message: text.substring(0, 100) };
                }

                // Show Status
                statusDiv.classList.remove('hidden');
                
                if (response.ok && data.success) {
                    // Success
                    statusDiv.className = "mt-8 p-6 bg-green-900/20 border border-green-500/30 rounded-xl flex flex-col items-center justify-center gap-3 animate-in fade-in zoom-in-95 duration-300 shadow-lg shadow-green-900/10";
                    iconBg.className = "p-3 bg-green-500/20 rounded-full";
                    icon.className = "text-green-400 w-8 h-8";
                    statusTitle.innerText = "Registration Successful";
                    statusTitle.className = "text-xl font-bold text-green-400";
                    statusMsg.innerText = data.message || "ECID Registered.";
                    statusMsg.className = "text-center font-mono text-sm opacity-90 text-green-400";
                } else {
                    // Error
                    statusDiv.className = "mt-8 p-6 bg-red-900/20 border border-red-500/30 rounded-xl flex flex-col items-center justify-center gap-3 animate-in fade-in zoom-in-95 duration-300 shadow-lg shadow-red-900/10";
                    iconBg.className = "p-3 bg-red-500/20 rounded-full";
                    icon.className = "text-red-400 w-8 h-8";
                    statusTitle.innerText = "Registration Failed";
                    statusTitle.className = "text-xl font-bold text-red-400";
                    statusMsg.innerText = data.message || `Server Error (${response.status})`;
                    statusMsg.className = "text-center font-mono text-sm opacity-90 text-red-400";
                }

            } catch (err) {
                statusDiv.classList.remove('hidden');
                statusDiv.className = "mt-8 p-6 bg-red-900/20 border border-red-500/30 rounded-xl flex flex-col items-center justify-center gap-3 animate-in fade-in zoom-in-95 duration-300 shadow-lg shadow-red-900/10";
                iconBg.className = "p-3 bg-red-500/20 rounded-full";
                icon.className = "text-red-400 w-8 h-8";
                statusTitle.innerText = "Connection Error";
                statusTitle.className = "text-xl font-bold text-red-400";
                statusMsg.innerText = (err.name === 'AbortError') ? "Server timed out." : "Check Server URL and internet.";
                statusMsg.className = "text-center font-mono text-sm opacity-90 text-red-400";
            } finally {
                btn.disabled = false;
                btnText.innerText = "Register ECID";
                btn.classList.remove('opacity-75');
            }
        });

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>